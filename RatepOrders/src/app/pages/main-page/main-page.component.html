<div class="wrapper">
  <app-menu></app-menu>
  <section class="orders">
    <!-- Блок модификации вывода (фильтрация, поиск) -->
    <div class="result-modificators">
      <!-- Поиск -->
      <div class="input">
        <label for="search">Поиск</label>
        <input id="search"
               type="text"
               placeholder="Введите номер договора, ФИО клиента, наименование или ИНН клиента..."
               [(ngModel)]="search">
      </div>

      <!-- Фильтрация -->
      <div class="filters">
        <div class="date-filters">
          <p>Дата договора</p>
          <div class="date-filters-wrapper">

            <div class="input">
              <label for="orderStartDate">От</label>
              <input type="date"
                     id="orderStartDate"
                     [(ngModel)]="startDate"
                     (focusout)="changeDate()">
            </div>

            <div class="input">
              <label for="orderEndDate">До</label>
              <input type="date"
                     id="orderEndDate"
                     [(ngModel)]="endDate"
                     (focusout)="changeDate()">
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Заказы -->
    <div class="order-list">
      <table *ngIf="filteredContracts().length != 0">
        <thead>
          <th>Номер</th>
          <th>ИНН клиента</th>
          <th>Клиент</th>
          <th>Действителен (от - до)</th>
          <th>Статус</th>
          <th>Договор</th>
          <th>Действия</th>
        </thead>
        <tbody>
          <ng-container *ngFor="let contract of filteredContracts()">

            <tr style="cursor: pointer;">
              <td (click)="viewToggle(contract)">{{contract.Number}}</td>
              <td (click)="viewToggle(contract)">{{contract.INN}}</td>
              <td (click)="viewToggle(contract)">{{contract.Fullname || contract.Name}}</td>
              <td (click)="viewToggle(contract)">{{contract.StartDate | date:'dd.MM.yyyy' : 'ru'}} - {{contract.EndDate
                | date:'dd.MM.yyyy': 'ru'}}
              </td>
              <td class="status"
                  (click)="viewToggle(contract)">{{contract.StatusName}}</td>
              <td><a [routerLink]="['/document', contract.ClientId.toString(), contract.ContractId.toString()]"
                   class="contract-link"
                   target="_blank">Печатать договор</a></td>
              <td>
                <p *ngIf="contract.StatusId === 4"
                   style="padding-left: 5px;">-</p>
                <button *ngIf="contract.StatusId == 1"
                        (click)="toSpecificationPage(contract.ClientId, contract.ContractId)">Сформировать</button>
                <div class="button-list"
                     *ngIf="contract.StatusId == 2">
                  <button>Закрыть</button>
                  <button (click)="toNewOrderPage(contract.ClientId, contract.ContractId)">Новый заказ</button>
                </div>
                <button *ngIf="contract.StatusId == 3">Выдать клиенту</button>
              </td>
            </tr>
            <td colspan="7"
                [ngClass]="{'hidden' : !contract.UI?.Visible}"
                *ngIf="(contract.Orders?.length || 0) > 0">

              <table class="order">
                <thead>
                  <th>№ п/п</th>
                  <th>Дата заказа</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </thead>

                <tbody>
                  <ng-container *ngFor="let order of contract.Orders">
                    <tr style="cursor: pointer"
                        (click)="viewToggle(order)">
                      <td>{{order.OrderId}}</td>
                      <td>{{order.OrderDate | date : 'dd.MM.yyyy' : 'ru'}}</td>
                      <td class="status">{{order.StatusName}}</td>
                      <td>
                        <div class="button-list">
                          <button *ngIf="order.StatusId == 2">Готов</button>
                        </div>
                      </td>
                    </tr>

                    <td colspan="7"
                        [ngClass]="{'hidden' : !order.UI?.Visible}">
                      <table class="order-composition">
                        <thead>
                          <th>№ п/п</th>
                          <th>Изделия</th>
                          <th>Количество</th>
                          <th>Цена</th>
                        </thead>

                        <tbody>
                          <tr *ngFor="let o of order.OrderComposition">
                            <td>{{o.OrdinalNumber}}</td>
                            <td>{{o.ProductName}}</td>
                            <td>{{o.Amount}} / {{o.MaxAmount}} (Остаток: {{o.MaxAmount - o.Amount}})</td>
                            <td>{{o.PriceValue | number : '1.2-2' : 'ru'}}</td>
                          </tr>
                        </tbody>
                      </table>
                      <span class="price sum">Сумма по заказу №{{order.OrderId}}: {{order.Sum | number : '1.2-2' :
                        'ru'}}</span>
                    </td>
                  </ng-container>
                </tbody>
              </table>
              <span class="price sum">Сумма договора: {{contract.Sum | number : '1.2-2' : 'ru'}}</span>
          </ng-container>
        </tbody>
      </table>
      <h1 *ngIf="filteredContracts().length == 0">Договоры не найдены</h1>
    </div>

    <button class="create-order-button"
            (click)="toNewContractPage()">Новый договор</button>
  </section>
</div>
